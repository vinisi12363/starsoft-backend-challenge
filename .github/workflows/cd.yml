name: CD Pipeline

on:
  workflow_run:
    workflows: ["CI Pipeline"]
    types:
      - completed
    branches:
      - main

jobs:
  deploy:
    name: Deploy to Production
    runs-on: ubuntu-latest
    if: ${{ github.event.workflow_run.conclusion == 'success' }}

    steps:
      - name: Deploy via SSH
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.HOST_ADDRESS }}
          username: ${{ secrets.HOST_USER }}
          password: ${{ secrets.HOST_PASSWORD }}
          # key: ${{ secrets.SSH_PRIVATE_KEY }} # Descomente se for usar chave SSH em vez de senha
          script: |
            # Parar o script se der erro
            set -e
            
            echo "üöÄ Iniciando Deploy..."
            
            # Navegar para a pasta correta
            echo "üìÇ Acessando /var/www/starsoft-backend-challenge..."
            cd /var/www/starsoft-backend-challenge || git clone https://github.com/${{ github.repository }} /var/www/starsoft-backend-challenge && cd /var/www/starsoft-backend-challenge
            
            # Atualizar c√≥digo
            echo "üì¶ Atualizando reposit√≥rio..."
            git pull origin main
            
            # Subir Containers (Modo Single Instance - Servidor Modesto)
            echo "üê≥ Subindo Docker (Single Instance)..."
            # Usando -f docker-compose.yml (padr√£o)
            docker compose up --build -d
            
            # Limpar imagens antigas para n√£o lotar o disco
            docker image prune -f
            
            echo "‚úÖ Deploy conclu√≠do com sucesso!"
